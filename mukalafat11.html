<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تسجيل مخالفة للمتدربات</title>
  <style>
    :root{font-family:system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#222;}
    body{margin:0;padding:18px;background:#f7f7f7;direction:rtl}
    .container{max-width:1100px;margin:0 auto;background:#fff;padding:16px;border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,0.06)}
    h1{margin:6px 0 14px 0;text-align:center}
    form{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input[type=text],input[type=time],input[type=date],select,textarea{
      width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;font-size:14px
    }
    textarea{min-height:44px;resize:vertical}
    .full{grid-column:1/-1}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:#2b7a78;color:#fff}
    .btn-ghost{background:#efefef}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .search{margin-right:auto;display:flex;gap:6px;align-items:center}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid #e6e6e6;text-align:right;font-size:14px}
    th{background:#fafafa;position:sticky;top:0}
    .small{font-size:12px;color:#666}
    .row-actions button{margin-left:6px}
    .expand-details{background:#fff;border:1px solid #ddd;padding:8px;border-radius:6px;margin-top:8px}
    @media (max-width:800px){
      form{grid-template-columns:repeat(1,1fr)}
      th,td{font-size:13px;padding:8px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>تسجيل مخالفة للمتدربات</h1>

    <!-- النموذج -->
    <form id="addForm">
      <div>
        <label>رقم المتدربة</label>
        <input type="text" id="traineeNumber" placeholder="مثال: 0970697" required />
      </div>
      <div>
        <label>اسم الطالبة</label>
        <input type="text" id="traineeName" placeholder="اسم الطالبة" required />
      </div>
      <div>
        <label>اسم المدربة</label>
        <input type="text" id="supervisorName" placeholder="اسم المدربة" />
      </div>
      <div>
        <label>المخالفة</label>
        <input type="text" id="violation" placeholder="مثال: uniform" required />
      </div>
      <div>
        <label>الإجراء المتخذ</label>
        <input type="text" id="actionTaken" placeholder="مثال: warning / خصم درجات" />
      </div>
      <div>
        <label>التاريخ</label>
        <input type="date" id="date" />
      </div>
      <div>
        <label>الوقت</label>
        <input type="time" id="time" />
      </div>
      <div class="full">
        <label>رأي وكيلة المتدربات (يبين بجنب عدد المخالفات)</label>
        <textarea id="opinion" placeholder="رأي وكيلة المتدربات أو تعليقها"></textarea>
      </div>

      <div class="full" style="display:flex;gap:8px;justify-content:flex-end">
        <button type="submit" class="btn btn-primary">أضف مخالفة</button>
        <button type="button" id="clearForm" class="btn btn-ghost">تفريغ النموذج</button>
      </div>
    </form>

    <!-- أدوات البحث / حذف -->
    <div class="controls">
      <div class="search">
        <label class="small">بحث برقم المتدربة:</label>
        <input type="text" id="searchNumber" placeholder="ادخل رقم المتدربة للبحث" />
        <button id="searchBtn" class="btn btn-ghost">بحث</button>
        <button id="resetSearch" class="btn btn-ghost">إظهار الكل</button>
      </div>

      <div style="display:flex;gap:6px">
        <input type="text" id="deleteNameInput" placeholder="اكتب اسم الطالبة للحذف" />
        <button id="deleteByName" class="btn btn-ghost">حذف بالطالبة (بالاسم)</button>
        <button id="exportBtn" class="btn btn-ghost">تصدير (JSON)</button>
        <button id="importBtn" class="btn btn-ghost">استيراد (JSON)</button>
        <input type="file" id="importFile" accept=".json" style="display:none" />
      </div></div>

    <!-- جدول النتائج -->
    <div id="tableWrap">
      <table id="summaryTable">
        <thead>
          <tr>
            <th>رقم المتدربة</th>
            <th>اسم الطالبة</th>
            <th>اسم المدربة</th>
            <th>عدد المخالفات</th>
            <th>رأي وكيلة المتدربات</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="detailsArea"></div>
  </div>

<script>
  const STORAGE_KEY = 'mukhalafat_records_v1';

  function loadRecords(){try{const raw=localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):[]}catch(e){return[]}}
  function saveRecords(arr){localStorage.setItem(STORAGE_KEY,JSON.stringify(arr))}
  function escapeHtml(s){if(!s)return'';return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
  function deepEqual(a,b){return JSON.stringify(a)===JSON.stringify(b)}

  const addForm=document.getElementById('addForm');
  const summaryTableBody=document.querySelector('#summaryTable tbody');
  const detailsArea=document.getElementById('detailsArea');
  const searchNumber=document.getElementById('searchNumber');

  function renderSummary(filterNumber=''){
    const records=loadRecords();
    const grouped={};
    for(const r of records){
      if(filterNumber && String(r.traineeNumber)!==String(filterNumber))continue;
      const key=r.traineeNumber||('no-'+(r.traineeName||'unknown'));
      if(!grouped[key])grouped[key]={traineeNumber:r.traineeNumber,traineeName:r.traineeName,supervisorName:r.supervisorName,opinions:[],records:[]};
      grouped[key].records.push(r);
      if(r.opinion&&r.opinion.trim())grouped[key].opinions.push(r.opinion.trim());
    }

    summaryTableBody.innerHTML='';
    const keys=Object.keys(grouped);
    if(keys.length===0){summaryTableBody.innerHTML='<tr><td colspan="6" class="small">لا توجد سجلات.</td></tr>';detailsArea.innerHTML='';return;}
    for(const key of keys){
      const g=grouped[key];
      const opinionText=g.opinions.length?g.opinions[g.opinions.length-1]:'';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${escapeHtml(g.traineeNumber||'')}</td>
        <td>${escapeHtml(g.traineeName||'')}</td>
        <td>${escapeHtml(g.supervisorName||'')}</td>
        <td style="text-align:center">${g.records.length}</td>
        <td>${escapeHtml(opinionText)}</td>
        <td class="row-actions">
          <button class="btn btn-ghost" data-action="show" data-id="${encodeURIComponent(key)}">عرض</button>
          <button class="btn btn-ghost" data-action="deleteOne" data-id="${encodeURIComponent(key)}">حذف (الكل)</button>
        </td>`;
      summaryTableBody.appendChild(tr);
    }
  }

  function showDetails(groupKey){
    const key=decodeURIComponent(groupKey);
    const records=loadRecords();
    const rows=records.filter(r=>(r.traineeNumber||('no-'+(r.traineeName||'unknown')))==key);
    if(rows.length===0){detailsArea.innerHTML='<div class="small">لا توجد تفاصيل</div>';return;}
    let html=`<div class="expand-details"><strong>تفاصيل للمُتدربة: ${escapeHtml(rows[0].traineeName||'')}</strong> - رقم: ${escapeHtml(rows[0].traineeNumber||'')}</div>`;
    html+='<table style="width:100%;margin-top:8px"><thead><tr><th>التاريخ</th><th>الوقت</th><th>المخالفة</th><th>الإجراء</th><th>رأي وكيلة المتدربات</th><th>حذف</th></tr></thead><tbody>';
    for(let i=0;i<rows.length;i++){
      const r=rows[i];
      html+=`<tr>
        <td>${escapeHtml(r.date||'')}</td>
        <td>${escapeHtml(r.time||'')}</td>
        <td>${escapeHtml(r.violation||'')}</td>
        <td>${escapeHtml(r.actionTaken||'')}</td>
        <td>${escapeHtml(r.opinion||'')}</td>
        <td><button class="btn btn-ghost" data-action="del-idx" data-idx="${i}" data-key="${encodeURIComponent(key)}">حذف صف</button></td>
      </tr>`;
    }
    html+='</tbody></table>';
    detailsArea.innerHTML=html;
  }

  function deleteGroup(groupKey){
    if(!confirm('بتأكيد تحبين تحذفين كل سجلات هالطالبة؟'))return;
    const key=decodeURIComponent(groupKey);let records=loadRecords();
    records=records.filter(r=>(r.traineeNumber||('no-'+(r.traineeName||'unknown')))!==key);
    saveRecords(records);
    renderSummary(searchNumber.value.trim());
    detailsArea.innerHTML='';
  }

  function deleteDetailRow(groupKey,idx){
    if(!confirm('بتأكيد تحبين تحذفين هالصف؟'))return;
    const key=decodeURIComponent(groupKey);
    let records=loadRecords();
    const rows=records.filter(r=>(r.traineeNumber||('no-'+(r.traineeName||'unknown')))==key);
    const target=rows[idx];
    const pos=records.findIndex(r=>deepEqual(r,target));
    if(pos!==-1)records.splice(pos,1);
    saveRecords(records);
    renderSummary(searchNumber.value.trim());
    showDetails(encodeURIComponent(key));
  }

  addForm.addEventListener('submit',e=>{
    e.preventDefault();
    const rec={
      traineeNumber:traineeNumber.value.trim(),
      traineeName:traineeName.value.trim(),
      supervisorName:supervisorName.value.trim(),
      violation:violation.value.trim(),
      actionTaken:actionTaken.value.trim(),
      date:date.value,
      time:time.value,
      opinion:opinion.value.trim(),
      createdAt:new Date().toISOString()
    };
    const arr=loadRecords();arr.push(rec);saveRecords(arr);
    addForm.reset();
    renderSummary(searchNumber.value.trim());
    alert('تمت إضافة المخالفة');
  });

  clearForm.addEventListener('click',()=>addForm.reset());

  summaryTableBody.addEventListener('click',ev=>{
    const btn=ev.target.closest('button');
    if(!btn)return;
    const action=btn.dataset.action,id=btn.dataset.id;
    if(action==='show')showDetails(id);
    else if(action==='deleteOne')deleteGroup(id);
  });

  detailsArea.addEventListener('click',ev=>{
    const btn=ev.target.closest('button');
    if(!btn)return;
    const action=btn.dataset.action;
    if(action==='del-idx'){deleteDetailRow(btn.dataset.key,Number(btn.dataset.idx));}
  });

  searchBtn.addEventListener('click',()=>{
    renderSummary(searchNumber.value.trim());
    detailsArea.innerHTML='';
  });
  resetSearch.addEventListener('click',()=>{
    searchNumber.value='';
    renderSummary();
    detailsArea.innerHTML='';
  });

  deleteByName.addEventListener('click',()=>{
    const name=deleteNameInput.value.trim();
    if(!name){alert('اكتبي اسم الطالبة اللي تبي تحذفين سجلاتها');return;}
    if(!confirm(`بتأكيد تحبين تحذفين كل السجلات اللي باسم "${name}" ؟`))return;
    let records=loadRecords();
    const before=records.length;
    records=records.filter(r=>r.traineeName!==name);
    saveRecords(records);
    renderSummary(searchNumber.value.trim());
    detailsArea.innerHTML='';
    alert(`انحذفت ${before-records.length} سجلاً باسم ${name}`);
  });

  exportBtn.addEventListener('click',()=>{
    const data=loadRecords();
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='mukhalafat_export.json';
    document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
  });

  importBtn.addEventListener('click',()=>importFile.click());
  importFile.addEventListener('change',e=>{
    const f=e.target.files[0];if(!f)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const parsed=JSON.parse(ev.target.result);
        if(!Array.isArray(parsed))throw new Error('الملف غير صالح');
        if(confirm('هل تودين إضافة السجلات المستوردة؟ اضغطي إلغاء للاستبدال الكامل.')){
          const current=loadRecords();saveRecords(current.concat(parsed));
        }else saveRecords(parsed);
        renderSummary();alert('تم الاستيراد بنجاح');
      }catch(err){alert('فشل الاستيراد');}
    };
    reader.readAsText(f,'utf8');importFile.value='';
  });

  renderSummary();
</script>
</body>
</html>